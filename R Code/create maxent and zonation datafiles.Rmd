Create data files for Maxent and Zonation analyses
========================================================

This script takes the downloaded data from the [Australian Living Atlas](http://www.ala.org.au/species-by-location/) and [NSW Atlas](http://www.environment.nsw.gov.au/atlaspublicapp/UI_Modules/ATLAS_/AtlasSearch.aspx) for all specified species, as well as the data from the brut dataset, and produces:   
1. a pdf of maps of all species locations (if `save.maps == TRUE`)   
2. a csv file of location points for all species for input into Maxent `maxent.data`   
3. a spp file for input into Zonation that lists all of the species ascii files and other attributes `zonation.spp`  

The first part of the script takes the brut dataset where species have been coded into taxonomic groups and identifies species that have more than the specified minimum number of records that fall within the Hunter region as masked by a shapefile. We extract all records for these species from within the NSW North Coast and Sydney Basin bioregions  

Then we run a loop that runs through the species listed as *Vulnerable* or *Endangered* under the NSW legislation on the NSW database that have more than the minumim number of records and extracts the latitude and longitude of all records in the ALA and NSW databases. Species that are listed as *MNES* species by the EPBC Act are also treated in the same way.  Data are only retained if they occur after a specified date.


```{r setup, fig.width=7, fig.height=6, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
#load packages and set working directory
rm(list=ls())

packages(ggplot2)
packages(ggmap)
packages(maptools)
packages(sp)
packages(rgdal)
packages(raster)

setwd("~/GIS_data/Hunter/species point data/")
 #load("Maxent_Zonation.Rdata")

# set output options
  save.maps <- FALSE  # save maps as pdf
  save.output <- TRUE # save maxent data as csv file
  include.brut <- FALSE # include brut dataset in maxent file
  include.ALA <- TRUE # include ALA data in maxent file
  export.ssi <- "txt" # format to export SSI (tif or txt)
  shutdown <- FALSE # shutdown computer when the script is finished

# a function that combines records from each region, allowing for the fact that they may be absent from a region
combine.records <- function (NC.records, SB.records) {
  tryCatch({
            rbind(NC.records,SB.records)
            }, error = function(err){
              if(is.null(NC.records)==TRUE & is.null(SB.records)==FALSE){
                return(SB.records)
              } else if(is.null(SB.records)==TRUE & is.null(NC.records)==FALSE){
                return(NC.records)
              } else cat("")
            })
  }

# set the google map background for the species plots and create background map
  map <- get_map(location = c(151.250,-32.490), zoom = 8, maptype="terrain", color="bw")

# import regional shapefiles for mapping and data filtering  
hunter.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS_data/Hunter/All data from harddrive/From DO/OEH_Lower_Hunter_18122012/Administrative/LHRS_Study_Area.shp")
  proj4string(hunter.mask) <- "+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
  hunter.mask <- spTransform(hunter.mask, CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
    hunter.mask.data <- fortify(hunter.mask)
  cma.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS_data/Hunter/Plans/HCR_CMA/HCR_CMA_GDA94.shp")
    cma.mask.data <- fortify(cma.mask)
  ibra.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS_data/Hunter/Plans/Bioregions/hunter_bioregions.shp")
    ibra.mask.data <- fortify(ibra.mask)
  hccrem.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS_data/Hunter/Plans/HCCREMS_AreaOfInterest/HCCREMS_AoI.shp")
    proj4string(hccrem.mask) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
    hccrem.mask.data <- fortify(hccrem.mask)

#create base map for species mapping
  print(base.map <- ggmap(map) + geom_polygon(aes(x = long, y = lat, group = group), data=hunter.mask.data, colour = 'yellow', fill = 'black', alpha = .1, size = .3) + geom_polygon(aes(x = long, y = lat, group = group), data=hccrem.mask.data, colour = 'orange', fill = 'black', alpha = .1, size = .3)) #+ geom_polygon(aes(x = long, y = lat, group = group), data=cma.mask.data, colour = 'pink', fill = 'black', alpha = .1, size = .3) + geom_polygon(aes(x = long, y = lat, group = group), data=ibra.mask.data, colour = 'light blue', fill = 'black', alpha = .1, size = .3)  

# The minimum number of records required for a species to be included  
  min.records <- 20
  
# The earliest date for selecting records
  min.date <- strptime("01/01/1990", "%d/%m/%Y")

# Minimum allowable spatial accuracy value (combined number of characters in lat & long ~100m)
  min.accuracy <- 14

# open species list
  protected.species <- read.csv("C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/IBRA threatened species list.csv")
    protected.species[,c("lower.hunter","greater.hunter","sdm")] <- NA

# identify the threatened species of interest for analysis
#   threatened.species <- rbind(protected.species[grep("E", protected.species$NSW.status),], protected.species[grep("V", protected.species$NSW.status),], protected.species[grep("TRUE", protected.species$mnes),])
#   threatened.species <- threatened.species[!duplicated(threatened.species),]
threatened.species <- protected.species[protected.species$ignore!="Y",]

# identify which species have at least 1 records across all atlases and should be included
species.list <- threatened.species$Scientific.Name[rowSums(threatened.species[,c("ALA.records","NSW.records","OEH.records")],na.rm=TRUE) > 0]
  species.list <- species.list[!is.na(species.list)==TRUE]

# create empty dataframes for the output data
  maxent.data <- d(species=NULL,longitude=NULL,latitude=NULL, database=NULL)
  gh.ssi.list <- NA
  lh.ssi.list <- NA

# a dump file for discarded points
discarded.records <- maxent.data

```

Species are kept for analysis in Maxent if they have more than `r min.records` records within the Hunter region that were observed after `r min.date`. 

```{r brut_analysis, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
# this is based on the NCAARF nationwide dataset and selects the species that have sufficient data within the Hunter region

if(include.brut == TRUE) {

    setwd("C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/")
  
  # open the brut dataset and generate spatial co-ordinates
    modeled.sp <- read.csv("C:/Users/awhitehead/Documents/GIS_data/Australia-wide/species_data/modeledsp_order_brut.csv")
      modeled.sp <- modeled.sp[!is.na(modeled.sp$YEARmax >= (min.date$year+1900)),]
      modeled.sp$database <- "brut"
    coordinates(modeled.sp) <- c("Lon_Centre","Lat_Centre")
  
    brut.maxent.data <- maxent.data
  
  # clip the brut data by the region mask, provided there are at least 30 points in the hunter region
    ibra.sp <- modeled.sp[ibra.mask,]
    hccrem.sp <- modeled.sp[hccrem.mask,]
  
  # identify how many observations for each species within the hunter
   n.obs <- d(obs=tapply(hccrem.sp$SEL,hccrem.sp$TAXON_ID,sum))
      n.obs$taxa <- rownames(n.obs)
      n.obs <- n.obs[n.obs$obs > min.records,]
  
  # extract each species with more than the minimum number of records from brut dataset 
    for (i in seq(n.obs$taxa)){
        input <- as.data.frame(hccrem.sp[hccrem.sp$TAXON_ID==n.obs$taxa[i],])
      colnames(input)[3:4] <- c("latitude", "longitude")
      input$species <- paste(input$Ordertot,input$TAXON_ID)
      
  #     if(nrow(input) > min.records){
        brut.maxent.data <- rbind(brut.maxent.data,input[,c("species","longitude", "latitude", "database")])
        sp.map <- base.map + geom_point(aes(x = longitude, y = latitude,color=database,shape=species), data = input, alpha=0.5)
        print(sp.map)
        cat("\n", "Adding", nrow(input), "records for", as.character(input$species[i]), "to maxent data")
  #     }
    }
    
}

```

```{r ALA_NSW_analysis, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
# this takes data from the ALA and NSW atlases and identifies which have sufficient data within the Hunter region

setwd("C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/")
atlas.maxent.data <- maxent.data
lh.ssi.zonation.data <- maxent.data
gh.ssi.zonation.data <- maxent.data

# set specifications for pdf file if save.maps == TRUE
    if(save.maps == TRUE & include.ALA == TRUE) pdf("species point data maps - ALA & NSW.pdf",paper="a4r")
    if(save.maps == TRUE & include.ALA == FALSE) pdf("species point data maps - NSW.pdf",paper="a4r")

# run loop to extract data from ALA and NSW atlas data by species 
for (i in seq(species.list)){
  # extract ALA data
 if(include.ALA == TRUE) {
    if (!is.na(threatened.species$Downloaded.ALA[threatened.species$Scientific.Name == species.list[i]]) == TRUE){
      ALA.data <- read.csv(paste0("ALA data/",species.list[i],".csv"))
  #       ALA.data <- ALA.data[ALA.data$Coordinate.Uncertainty.in.Metres...parsed <= min.accuracy,]
        ALA.labels <- c("Latitude...processed", "Longitude...processed")
      colnames(ALA.data)[which(names(ALA.data) %in% ALA.labels)] <- c("latitude", "longitude")
      ALA.data$index <- paste(sprintf("%.6f",ALA.data$latitude), sprintf("%.6f",ALA.data$longitude))
      ALA.data$database <- "ALA"
      ALA.data$species <- species.list[i]
      ALA.data <- ALA.data[!is.na(ALA.data$Year...parsed >= (min.date$year+1900)),]
      ALA.data$accuracy.digits <- nchar(ALA.data$latitude,type="chars") + nchar(ALA.data$longitude,type="chars")
      discarded.records <- rbind(discarded.records,ALA.data[ALA.data$accuracy.digits < min.accuracy,c("species","longitude","latitude","database")])
      ALA.data <- ALA.data[ALA.data$accuracy.digits >=min.accuracy,]
    } else ALA.data <- NULL
  } else  ALA.data <- NULL

  #extract NSW Atlas data
  if (!is.na(threatened.species$Downloaded.NSW[threatened.species$Scientific.Name == species.list[i]]) == TRUE){
    NSW.data <- read.csv(paste0("NSW Atlas data/",species.list[i],".csv"))
      NSW.data$Rdate <- strptime(NSW.data$DateLast, "%d/%m/%Y")
      NSW.data <- NSW.data[!is.na(NSW.data$Rdate >= min.date),]
    NSW.labels <- c("Latitude_GDA94","Longitude_GDA94")
    colnames(NSW.data)[which(names(NSW.data) %in% NSW.labels)] <- c("latitude", "longitude")
    NSW.data$index <- paste(sprintf("%.6f",NSW.data$latitude), sprintf("%.6f",NSW.data$longitude))
    NSW.data$database <- "NSW"
    NSW.data$species <- species.list[i]
    NSW.data$accuracy.digits <- nchar(NSW.data$latitude,type="chars") + nchar(NSW.data$longitude,type="chars")
    discarded.records <- rbind(discarded.records,NSW.data[NSW.data$accuracy.digits < min.accuracy,c("species","longitude","latitude","database")])
    NSW.data <- NSW.data[NSW.data$accuracy.digits >=min.accuracy,]
  } else NSW.data <- NULL
 
 if (!is.na(threatened.species$Downloaded.OEH[threatened.species$Scientific.Name == species.list[i]]) == TRUE){
    OEH.data <- read.csv(paste0("OEH data/",species.list[i],".csv"))
      OEH.data$Rdate <- strptime(OEH.data$YEAR, "%Y")
      OEH.data <- OEH.data[!is.na(OEH.data$Rdate >= min.date),]
    OEH.data$index <- paste(sprintf("%.6f",OEH.data$latitude), sprintf("%.6f",OEH.data$longitude))
    OEH.data$database <- "OEH"
    OEH.data$species <- species.list[i]
    OEH.data$accuracy.digits <- nchar(OEH.data$latitude,type="chars") + nchar(OEH.data$longitude,type="chars")
    discarded.records <- rbind(discarded.records,OEH.data[OEH.data$accuracy.digits < min.accuracy,c("species","longitude","latitude","database")])
    OEH.data <- OEH.data[OEH.data$accuracy.digits >=min.accuracy,]
  } else OEH.data <- NULL
  
  ALA.NSW.data <- combine.records(ALA.data[,c("species","longitude","latitude","database")],NSW.data[,c("species","longitude","latitude","database")])
    ALA.NSW.data <- combine.records(ALA.NSW.data,OEH.data[,c("species","longitude","latitude","database")])
  
 tryCatch({
   coordinates(ALA.NSW.data) <- c("longitude", "latitude")
    proj4string(ALA.NSW.data) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
    
    lower_hunter.sp <- ALA.NSW.data[hunter.mask,]
      lower_hunter.sp <- as.data.frame(lower_hunter.sp)
  
    # only include species if more than the minimum number of records occur in the lower hunter
      in.lower_hunter <- nrow(lower_hunter.sp)
   
   hccrem.sp <- ALA.NSW.data[hccrem.mask,]
      hccrem.sp <- as.data.frame(hccrem.sp) 
  
    # only include species if more than the minimum number of records occur in the hunter
      in.hunter <- nrow(hccrem.sp)
    
    # produce maps of the distribution of each species
    if(in.hunter >= min.records) {
      if(save.maps == TRUE){
        #sp.map <- base.map + geom_point(aes(x = longitude, y = latitude,color=database, shape=species), data = hccrem.sp, alpha=0.5) + ggtitle(paste(in.hunter, "records")) + scale_fill_discrete(labels=paste("ALA -",nrow(hccrem.sp[hccrem.sp$database=="ALA",])))
         #print(sp.map)
      }
    
    # output data for maxent analyses
      atlas.maxent.data <- rbind(atlas.maxent.data,hccrem.sp)
      cat("\n", "Adding", in.hunter, "records for", as.character(species.list[i]), "to maxent data")
  
      } else {
        if(0 < in.hunter & in.hunter < min.records) {
        # list species with less than minimum records for inclusion as species of special interest
        gh.ssi.list <- append(gh.ssi.list,as.character(unique(hccrem.sp$species)))
        gh.ssi.zonation.data <- rbind(gh.ssi.zonation.data, hccrem.sp)
        cat("\n", "Adding", in.hunter, "records for", as.character(species.list[i]), "as species of special interest in greater hunter")
      }
        }
   
   if(0 < in.lower_hunter & in.lower_hunter < min.records) {
        # list species with less than minimum records for inclusion as species of special interest
        lh.ssi.list <- append(lh.ssi.list,as.character(unique(lower_hunter.sp$species)))
        lh.ssi.zonation.data <- rbind(lh.ssi.zonation.data, lower_hunter.sp)
        cat("\n", "Adding", in.lower_hunter, "records for", as.character(species.list[i]), "as species of special interest in lower hunter")
      }
      
   #if(in.lower_hunter >0) protected.species$lower.hunter[protected.species$Scientific.Name==species.list[i]] <- "TRUE"
   #if(in.hunter > 0) protected.species$greater.hunter[protected.species$Scientific.Name==species.list[i]] <- "TRUE"
   
    
    # remove all species-specific datafiles, so they don't mess up the next round of the loop
    suppressWarnings(rm(ALA.data, NSW.data, OEH.data, ALA.NSW.data, hccrem.sp,in.hunter,sp.map,lower_hunter.sp,in.lower_hunter))
    gc()
 
 }, error=function(err) cat(""), warning=function(war) cat(""))
}

# close pdf file
  if(save.maps == TRUE) dev.off()

```


These are combined together in `maxent.data` where there are `r nrow(maxent.data)` records for `r (length(species.list) + n.species)` species.  A map of the distribution of each species is saved in a pdf file (*C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/species point data maps.pdf*)

```{r export_maxent.data, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
if(include.brut == TRUE) {
    gda_maxent.data <- rbind(brut.maxent.data[,c("species","longitude","latitude")], atlas.maxent.data[,c("species","longitude","latitude")])
    } else gda_maxent.data <- atlas.maxent.data[,c("species","longitude","latitude","database")]

h(gda_maxent.data)

# convert maxent data to GDA94 Transverse Mercator Zone 56 to match the rest of the data
  coordinates(gda_maxent.data) <- c("longitude", "latitude")
  
  # set current projection
  proj4string(gda_maxent.data) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

  # transform to new projection
  project_maxent.data <- spTransform(gda_maxent.data, CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

  # convert back to a dataframe
  gda.tm_maxent.data <- as.data.frame(project_maxent.data)
    names(gda.tm_maxent.data)[3:4] <- c("easting","northing")
    # hack to get the ALA records in the same projection as the Bionet records
    gda.tm_maxent.data$northing[gda.tm_maxent.data$database=="ALA"] <- gda.tm_maxent.data$northing[gda.tm_maxent.data$database=="ALA"] + 176.9
    gda.tm_maxent.data$easting[gda.tm_maxent.data$database=="ALA"] <- gda.tm_maxent.data$easting[gda.tm_maxent.data$database=="ALA"] + 104

  h(gda.tm_maxent.data)

  # remove duplicate records for each species (i.e. keep only one for each grid cell)
  hccrems.raster <- raster("C:/Users/awhitehead/Documents/GIS_Data/Hunter/Maxent_files/ghm_environmental_data/hccrems_mask.asc")
  hunter.mask.tm <- spTransform(hunter.mask,CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))
hccrem.mask.tm <- spTransform(hccrem.mask,CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

  export_maxent.data <- maxent.data
  export_ssi.zonation.data <- maxent.data # catch the species that get dropped due to duplicate removal
  
    for(i in seq(unique(gda.tm_maxent.data$species))){
      input <- gda.tm_maxent.data[gda.tm_maxent.data$species==unique(gda.tm_maxent.data$species)[i],]
      cell <- cellFromXY(hccrems.raster,input[,3:4])
      output <- input[!duplicated(cell),]
      
      coordinates(output) <- c("easting","northing")
      proj4string(output)<-"+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

      #check if there are more than the min records in lower hunter
      in.lh <- 0
      tryCatch({
        in.lh <- nrow(output[hunter.mask.tm,])
      }, error=function(err) cat(""), warning=function(war) cat(""))
      
      #check if there are more than the min records in greater hunter
      in.gh <- 0
      tryCatch({
        in.gh <- nrow(output[hccrem.mask.tm,])
      }, error=function(err) cat(""), warning=function(war) cat(""))
      
      output <- as.data.frame(output)
      
      if(in.gh >= min.records){
        export_maxent.data <- rbind(export_maxent.data,output)
        protected.species$sdm[protected.species$Scientific.Name==unique(gda.tm_maxent.data$species)[i]] <- "TRUE"     
        
        } else export_ssi.zonation.data <- rbind(export_ssi.zonation.data,output)      
      
      if(include.ALA==TRUE) protected.species$final.ALA.NSW.records[protected.species$Scientific.Name==unique(gda.tm_maxent.data$species)[i]] <- nrow(output)
      protected.species$lower.hunter[protected.species$Scientific.Name==unique(gda.tm_maxent.data$species)[i]] <- in.lh
      
      #if(include.ALA==FALSE) protected.species$final.NSW.records[protected.species$Scientific.Name==unique(gda.tm_maxent.data$species)[i]] <- nrow(output)
         
      rm(input,cell,output,in.lh,in.gh)
    }

export.species <- unique(export_maxent.data$species)
  export_maxent.data <- export_maxent.data[,colnames(export_maxent.data)!="database"]
                                  
# save data for species with greater than the minimum number of records after the minimum date in the Hunter region to one file for Maxent analysis
if(save.output ==TRUE) {
  if(include.ALA == TRUE) write.csv(export_maxent.data, "C:/Users/awhitehead/Documents/GIS_data/Hunter/Maxent_files/species_data/maxent.data_ALA.NSW.csv",row.names=FALSE)
   
  if(include.ALA == FALSE) write.csv(export_maxent.data, "C:/Users/awhitehead/Documents/GIS_data/Hunter/Maxent_files/species_data/maxent.data_NSW.csv",row.names=FALSE)

  taxa <- unique(protected.species$Taxa)
  
  for(t in seq(taxa)){
    taxa.species <- intersect(protected.species$Scientific.Name[which(protected.species$Taxa==taxa[t])],export_maxent.data$species)
    taxa.maxent <- export_maxent.data[export_maxent.data$species %in% taxa.species,]
    write.csv(taxa.maxent,paste0("~/GIS_data/Hunter/Maxent_files/species_data/maxent.data_",taxa[t],".csv"),row.names=FALSE )
    rm(taxa.species, taxa.maxent)
  }

  
# save changes to the protected species file  
  
  write.csv(protected.species, "C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/IBRA threatened species list.csv", row.names=FALSE)

cat("\n", nrow(export_maxent.data), "records for", length(export.species), "species exported to maxent.data.csv")
  }
```

```{r lh.ssi_data, message=FALSE, warning=FALSE, comment="", tidy=TRUE}

gda_lh.ssi.zonation.data <- lh.ssi.zonation.data[,c("species","longitude","latitude","database")]

h(gda_lh.ssi.zonation.data)

# convert maxent data to GDA94 Transverse Mercator Zone 56 to match the rest of the data
  coordinates(gda_lh.ssi.zonation.data) <- c("longitude", "latitude")
  
  # set current projection
  proj4string(gda_lh.ssi.zonation.data) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

  # transform to new projection
  project_lh.ssi.zonation.data <- spTransform(gda_lh.ssi.zonation.data, CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

  # convert back to a dataframe
  gda.tm_lh.ssi.zonation.data <- as.data.frame(project_lh.ssi.zonation.data)
    names(gda.tm_lh.ssi.zonation.data)[3:4] <- c("easting","northing")
    gda.tm_lh.ssi.zonation.data$northing[gda.tm_lh.ssi.zonation.data$database=="ALA"] <- gda.tm_lh.ssi.zonation.data$northing[gda.tm_lh.ssi.zonation.data$database=="ALA"] + 176.9
    gda.tm_lh.ssi.zonation.data$easting[gda.tm_lh.ssi.zonation.data$database=="ALA"] <- gda.tm_lh.ssi.zonation.data$easting[gda.tm_lh.ssi.zonation.data$database=="ALA"] + 104

  h(gda.tm_lh.ssi.zonation.data)

  # remove duplicate records for each species (i.e. keep only one for each grid cell)
  hccrems.raster <- raster("C:/Users/awhitehead/Documents/GIS_Data/Hunter/Maxent_files/ghm_environmental_data/hccrems_mask.asc")

export_lh.ssi.zonation.data <- export_ssi.zonation.data
  
    for(i in seq(unique(gda.tm_lh.ssi.zonation.data$species))){
      input <- gda.tm_lh.ssi.zonation.data[gda.tm_lh.ssi.zonation.data$species==unique(gda.tm_lh.ssi.zonation.data$species)[i],]
      cell <- cellFromXY(hccrems.raster,input[,3:4])
      output <- input[!duplicated(cell),]
      export_lh.ssi.zonation.data <- rbind(export_lh.ssi.zonation.data,output)
        #if(include.ALA==TRUE) protected.species$final.ALA.NSW.records[protected.species$Scientific.Name==unique(gda.tm_lh.ssi.zonation.data$species)[i]] <- nrow(output)
        #if(include.ALA==FALSE) protected.species$final.NSW.records[protected.species$Scientific.Name==unique(gda.tm_lh.ssi.zonation.data$species)[i]] <- nrow(output) 
      rm(input,cell,output)
    }

lh.ssi.export.species <- unique(export_lh.ssi.zonation.data$species)
                                
# save data for species with greater than the minimum number of records after the minimum date in the Lower Hunter region to one file for Maxent analysis
if(save.output ==TRUE) {
  
  if(export.ssi == "txt"){
  export_lh.ssi.zonation.data$biological.value <- 1.0
  export_lh.ssi.zonation.data$uncertainty <- 0
  
    
    for (i in seq(lh.ssi.export.species)) {
      export <- export_lh.ssi.zonation.data[export_lh.ssi.zonation.data$species == lh.ssi.export.species[i],]
        export <- export[,colnames(export)!="database"]
      write.table(export[,!names(export) %in% c("species")], paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/lower hunter/ssi_files/",lh.ssi.export.species[i],"_LH.txt"),row.names=FALSE, sep="\t", col.names=FALSE)
    }
     
    #write.csv(protected.species, "C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/IBRA threatened species list.csv", row.names=FALSE)
  
  cat("\n", nrow(export_lh.ssi.zonation.data), "records exported to", length(lh.ssi.export.species), "individual ssi csv files")
    }
   
  if(export.ssi == "tif"){
    presence.absence.raster <- function (mask.raster,species.data,raster.label="") {
    #set the cells that contain points to 1
  speciesRaster <- rasterize(species.data,mask.raster,field=1)
    speciesRaster <- merge(speciesRaster,mask.raster)
    #label the raster
    names(speciesRaster) <- raster.label
   writeRaster(speciesRaster,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/lower hunter/",raster.label,"_LH.tif"), format="GTiff",overwrite=T)
  cat("Converted",raster.label,"to raster","\n")
}
    
   for (i in seq(lh.ssi.export.species)) {
      export <- export_lh.ssi.zonation.data[export_lh.ssi.zonation.data$species == lh.ssi.export.species[i],]
      export <- export[,3:4]
      species <- as.character(gsub(" ","_",lh.ssi.export.species[i]))
      presence.absence.raster(hccrems.raster,export, raster.label=species)
    } 
    
  }
  }

```

```{r gh.ssi_data, message=FALSE, warning=FALSE, comment="", tidy=TRUE}

gda_gh.ssi.zonation.data <- gh.ssi.zonation.data[,c("species","longitude","latitude","database")]

h(gda_gh.ssi.zonation.data)

# convert maxent data to GDA94 Transverse Mercator Zone 56 to match the rest of the data
  coordinates(gda_gh.ssi.zonation.data) <- c("longitude", "latitude")
  
  # set current projection
  proj4string(gda_gh.ssi.zonation.data) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

  # transform to new projection
  project_gh.ssi.zonation.data <- spTransform(gda_gh.ssi.zonation.data, CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

  # convert back to a dataframe
  gda.tm_gh.ssi.zonation.data <- as.data.frame(project_gh.ssi.zonation.data)
    names(gda.tm_gh.ssi.zonation.data)[3:4] <- c("easting","northing")
    gda.tm_gh.ssi.zonation.data$northing[gda.tm_gh.ssi.zonation.data$database=="ALA"] <- gda.tm_gh.ssi.zonation.data$northing[gda.tm_gh.ssi.zonation.data$database=="ALA"] + 176.9
    gda.tm_gh.ssi.zonation.data$easting[gda.tm_gh.ssi.zonation.data$database=="ALA"] <- gda.tm_gh.ssi.zonation.data$easting[gda.tm_gh.ssi.zonation.data$database=="ALA"] + 104

  h(gda.tm_gh.ssi.zonation.data)

  # remove duplicate records for each species (i.e. keep only one for each grid cell)
  hccrems.raster <- raster("C:/Users/awhitehead/Documents/GIS_Data/Hunter/Maxent_files/ghm_environmental_data/hccrems_mask.asc")

export_gh.ssi.zonation.data <- export_ssi.zonation.data
  
    for(i in seq(unique(gda.tm_gh.ssi.zonation.data$species))){
      input <- gda.tm_gh.ssi.zonation.data[gda.tm_gh.ssi.zonation.data$species==unique(gda.tm_gh.ssi.zonation.data$species)[i],]
      cell <- cellFromXY(hccrems.raster,input[,3:4])
      output <- input[!duplicated(cell),]
      export_gh.ssi.zonation.data <- rbind(export_gh.ssi.zonation.data,output)
        if(include.ALA==TRUE) protected.species$final.ALA.NSW.records[protected.species$Scientific.Name==unique(gda.tm_gh.ssi.zonation.data$species)[i]] <- nrow(output)
        #if(include.ALA==FALSE) protected.species$final.NSW.records[protected.species$Scientific.Name==unique(gda.tm_gh.ssi.zonation.data$species)[i]] <- nrow(output) 
      rm(input,cell,output)
    }

gh.ssi.export.species <- unique(export_gh.ssi.zonation.data$species)
                                
# save data for species with greater than the minimum number of records after the minimum date in the Hunter region to one file for Maxent analysis
if(save.output ==TRUE) {
  
  if(export.ssi == "txt"){
  export_gh.ssi.zonation.data$biological.value <- 1.0
  export_gh.ssi.zonation.data$uncertainty <- 0
  
    
    for (i in seq(gh.ssi.export.species)) {
      export <- export_gh.ssi.zonation.data[export_gh.ssi.zonation.data$species == gh.ssi.export.species[i],]
        export <- export[,colnames(export)!="database"]
      write.table(export[,!names(export) %in% c("species")], paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/ssi_files/",gh.ssi.export.species[i],"_GH.txt"),row.names=FALSE, sep="\t", col.names=FALSE)
    }
     
    write.csv(protected.species, "C:/Users/awhitehead/Documents/GIS_data/Hunter/species point data/IBRA threatened species list.csv", row.names=FALSE)
  
  cat("\n", nrow(export_gh.ssi.zonation.data), "records exported to", length(gh.ssi.export.species), "individual ssi csv files")
    }
   
  if(export.ssi == "tif"){
    presence.absence.raster <- function (mask.raster,species.data,raster.label="") {
    #set the cells that contain points to 1
  speciesRaster <- rasterize(species.data,mask.raster,field=1)
    speciesRaster <- merge(speciesRaster,mask.raster)
    #label the raster
    names(speciesRaster) <- raster.label
   writeRaster(speciesRaster,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/",raster.label,"_GH.tif"), format="GTiff",overwrite=T)
  cat("Converted",raster.label,"to raster","\n")
}
    
   for (i in seq(gh.ssi.export.species)) {
      export <- export_gh.ssi.zonation.data[export_gh.ssi.zonation.data$species == gh.ssi.export.species[i],]
      export <- export[,3:4]
      species <- as.character(gsub(" ","_",gh.ssi.export.species[i]))
      presence.absence.raster(hccrems.raster,export, raster.label=species)
    } 
    
  }
  }

```

```{r export discarded records}

h(discarded.records)

# convert maxent data to GDA94 Transverse Mercator Zone 56 to match the rest of the data
  coordinates(discarded.records) <- c("longitude", "latitude")
  
  # set current projection
  proj4string(discarded.records) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

  # transform to new projection
  project_discarded.records <- spTransform(discarded.records, CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

  # convert back to a dataframe
  project_discarded.records <- as.data.frame(project_discarded.records)
    names(project_discarded.records)[2:3] <- c("easting","northing")

  h(project_discarded.records)

  write.csv(discarded.records, "C:/Users/awhitehead/Documents/GIS_data/Hunter/Maxent_files/species_data/discarded.records.csv",row.names=FALSE)

```


The `zonation.spp` table lists each species and the required input for zonation.  These are currently all set to `1` and will require some tinkering as we get further down the line. This assumes that we will run all the listed species in Maxent from `maxent.data.csv`, creating all the relevant ascii files. *Or we will use this same data in biomod2.*

```{r export_zonation.file, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
# this code block produces two species lists for zonation analyses based on the above data: one with all threatened species with sufficient data for the maxent analysis and one with just the MNES species
  
  zonation.spp <- d(weight=rep(1.0,length(export.species)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )
    zonation.spp$species <- paste0(export.species,".tif")
    zonation.spp$species <- gsub(" ","_",zonation.spp$species)

mnes.export.species <- export.species[which(export.species %in% protected.species$Scientific.Name[protected.species$mnes == TRUE])]

mnes.zonation.spp <- d(weight=rep(1.0,length(mnes.export.species)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )
    mnes.zonation.spp$species <- paste0(mnes.export.species,".tif")
    mnes.zonation.spp$species <- gsub(" ","_",mnes.zonation.spp$species)

h(zonation.spp)
  
# species of special interest in lower hunter
  lh.ssi.list <- lh.ssi.export.species
  
#   # mnes species of special interest
#   mnes.ssi.list <- ssi.list[which(ssi.list %in% protected.species$Scientific.Name[protected.species$mnes == TRUE])]
#   mnes.ssi.zonation.spp <- d(weight=rep(1.0,length(mnes.ssi.list)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )
#     mnes.ssi.zonation.spp$species <- paste0(mnes.ssi.list,".txt")

  lh.ssi.list <- gsub(" ","_",lh.ssi.list)
  lh.ssi.zonation.spp <- d(weight=rep(1.0,length(lh.ssi.list)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )
  lh.ssi.zonation.spp$species <- paste0(lh.ssi.list,".txt")

lh.zonation.spp <- rbind(zonation.spp, lh.ssi.zonation.spp)
  lh.zonation.spp$species <- gsub(".txt",".tif",lh.zonation.spp$species)
  lh.zonation.spp <- lh.zonation.spp[!duplicated(lh.zonation.spp$species),]

# species of special interest
  gh.ssi.list <- gh.ssi.export.species
  
  # mnes species of special interest
#   mnes.ssi.list <- ssi.list[which(ssi.list %in% protected.species$Scientific.Name[protected.species$mnes == TRUE])]
#   mnes.ssi.zonation.spp <- d(weight=rep(1.0,length(mnes.ssi.list)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )
#     mnes.ssi.zonation.spp$species <- paste0(mnes.ssi.list,".txt")

  gh.ssi.list <- gsub(" ","_",gh.ssi.list)
  gh.ssi.zonation.spp <- d(weight=rep(1.0,length(gh.ssi.list)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )
  gh.ssi.zonation.spp$species <- paste0(gh.ssi.list,".txt")

gh.zonation.spp <- rbind(zonation.spp, gh.ssi.zonation.spp)
  gh.zonation.spp$species <- gsub(".txt",".tif",gh.zonation.spp$species)
  gh.zonation.spp <- gh.zonation.spp[!duplicated(gh.zonation.spp$species),]

if(save.output ==TRUE) {
  write.table(zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/zonation.spp"),sep="\t",row.names=FALSE, col.names=FALSE)
   # write.table(mnes.zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/mnes.zonation.spp"),sep="\t",row.names=FALSE, col.names=FALSE)
  write.table(lh.ssi.zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/lh.ssi.zonation.txt"),sep="\t",row.names=FALSE, col.names=FALSE)
  write.table(gh.ssi.zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/gh.ssi.zonation.txt"),sep="\t",row.names=FALSE, col.names=FALSE)
  #write.table(mnes.ssi.zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/mnes.ssi.zonation.spp"),sep="\t",row.names=FALSE, col.names=FALSE)
 write.table(lh.zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/lh.zonation.spp"),sep="\t",row.names=FALSE, col.names=FALSE)
  write.table(gh.zonation.spp,paste0("C:/Users/awhitehead/Documents/GIS_data/Hunter/zonation/greater hunter/gh.zonation.spp"),sep="\t",row.names=FALSE, col.names=FALSE)
}

cat("\n", "zonation.spp file saved with default values for all SDM",length(export.species),"species", "\n", "mnes.zonation.spp file saved with default values for all",length(mnes.export.species),"species","\n", "lh.ssi.zonation.txt file saved with default values for all",length(lh.ssi.list),"species","\n", "gh.ssi.zonation.txt file saved with default values for all",length(gh.ssi.list),"species","\n", "lh.zonation.spp file saved with default values for ",nrow(lh.zonation.spp),"lower hunter species","\n", "gh.zonation.spp file saved with default values for ",nrow(gh.zonation.spp),"greater hunter species")
```


```{r shutdown}
if(shutdown == TRUE) system("C:/Windows/system32/shutdown.exe -f -s -t 240")

```
*This file was last updated on 15 July 2013 and last run on `r format(Sys.time(), "%d %B %Y")`.*
