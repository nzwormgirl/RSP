Create data files for Maxent and Zonation analyses
========================================================

This script takes the downloaded data from the [Australian Living Atlas](http://www.ala.org.au/species-by-location/) and [NSW Atlas](http://www.environment.nsw.gov.au/atlaspublicapp/UI_Modules/ATLAS_/AtlasSearch.aspx) for all specified species with more than the specified minimum number of records, as well as the data from the brut dataset, and produces:   
1. a pdf of maps of all species locations (if `save.maps == TRUE`)   
2. a csv file of location points for input into Maxent `maxent.data`   
3. a spp file for input into Zonation that lists all of the species ascii files and other attributes `zonation.spp`  

The first part of the script takes the brut dataset where species have been coded into taxonomic groups and identifies species that have more than the specified minimum number of records that fall within the Hunter region as masked by a shapefile. We extract all records for these species from within the NSW North Coast and Sydney Basin bioregions  

Then we run a loop that runs through the species listed as *Vulnerable* or *Endangered* under the NSW legislation on the NSW database that have more than the minumim number of records and extracts the latitude and longitude of all records in the ALA and NSW databases.   

*Note that these records are for the entire time period - this will need to be confined to something more sensible*


```{r setup, fig.width=7, fig.height=6, message=FALSE, warning=FALSE, comment=""}
#load packages and set working directory
rm(list=ls())

packages(ggplot2)
packages(ggmap)
packages(maptools)
packages(sp)
packages(rgdal)

setwd("C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/")

# save the maps as a pdf
  save.maps <- TRUE
  save.output <- TRUE

combine.records <- function (NC.records, SB.records) {
  tryCatch({
            rbind(NC.records,SB.records)
            }, error = function(err){
              if(is.null(NC.records)==TRUE & is.null(SB.records)==FALSE){
                return(SB.records)
              } else if(is.null(SB.records)==TRUE & is.null(NC.records)==FALSE){
                return(NC.records)
              } else cat("")
            })
  }

# set the google map background for the species plots and create background map
  map <- get_map(location = c(151.250,-32.490), zoom = 6, maptype="hybrid", color="bw")
  hunter.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS data/Hunter/data from Brendan/data/variables/projected GDA94/poly_lower_hunter.shp")
    hunter.mask.data <- fortify(hunter.mask)
  cma.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS data/Hunter/Plans/HCR_CMA/HCR_CMA_GDA94.shp")
    cma.mask.data <- fortify(cma.mask)
  ibra.mask <- readShapePoly("C:/Users/awhitehead/Documents/GIS data/Hunter/Plans/Bioregions/hunter_bioregions.shp")
    ibra.mask.data <- fortify(ibra.mask)
  print(base.map <- ggmap(map) + geom_polygon(aes(x = long, y = lat, group = group), data=hunter.mask.data, colour = 'yellow', fill = 'black', alpha = .1, size = .3) + geom_polygon(aes(x = long, y = lat, group = group), data=ibra.mask.data, colour = 'light blue', fill = 'black', alpha = .1, size = .3))

# The minimum number of records required for a species to be included  
  min.records <- 30

# open species list
  protected.species <- read.csv("C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/IBRA threatened species list.csv")
  threatened.species <- rbind(protected.species[grep("E", protected.species$NSW.status),], protected.species[grep("V", protected.species$NSW.status),])
    threatened.species <- threatened.species[!duplicated(threatened.species),]

#identify which species have more than the minimum number of records across both atlases
species.list <- threatened.species$Scientific.Name[rowSums(threatened.species[,c("ALA.records","NSW.records")],na.rm=TRUE)>min.records]
  species.list <- species.list[!is.na(species.list)==TRUE]

# create empty dataframes for the output data
  maxent.data <- d(species=NULL,longitude=NULL,latitude=NULL, database=NULL)
  atlas.zonation.spp <- d(weight=rep(1.0,length(species.list)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )

```

```{r brut_analysis, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
  setwd("C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/")

# open the brut dataset and generate spatial co-ordinates
  modeled.sp <- read.csv("C:/Users/awhitehead/Documents/GIS data/Australia-wide/species data/modeledsp_order_brut.csv")
  modeled.sp$database <- "brut"
  coordinates(modeled.sp) <- c("Lon_Centre","Lat_Centre")

# clip the brut data by the IBRA mask, provided there are at least 30 points in the hunter region
  ibra.sp <- modeled.sp[ibra.mask,]
  hunter.sp <- modeled.sp[hunter.mask,]

# identify how many observations for each species within the hunter
 n.obs <- d(obs=tapply(hunter.sp$SEL,hunter.sp$TAXON_ID,sum))
    n.obs$taxa <- rownames(n.obs)
    n.obs <- n.obs[n.obs$obs > min.records,]
    brut.zonation.spp <- d(weight=rep(1.0,nrow(n.obs)), alpha=1.0, bqp.row=1.0, bqp.buffer=1.0, cell.removal=1.0, species=NA )

# set specifications for pdf file if save.maps == TRUE
  if(save.maps == TRUE) pdf("species point data maps.pdf",paper="a4r")

# extract each species with more than the minimum number of records from brut dataset 
  for (i in seq(n.obs$taxa)){
      input <- as.data.frame(ibra.sp[ibra.sp$TAXON_ID==n.obs$taxa[i],])
    colnames(input)[3:4] <- c("latitude", "longitude")
    input$species <- paste(input$Ordertot,input$TAXON_ID)
    
#     if(nrow(input) > min.records){
      maxent.data <- rbind(maxent.data,input[,c("species","longitude", "latitude", "database")])
      print(sp.map <- base.map + geom_point(aes(x = longitude, y = latitude,color=species), data = input, alpha=0.5))
      brut.zonation.spp$species[i] <- glue(unique(input$species),".asc")
      cat("\n", "Adding", nrow(input), "records for", as.character(input$species[i]), "to maxent data")
#     }
  }

# create the zonation.spp file for the brut dataset
  brut.zonation.spp <- brut.zonation.spp[!is.na(brut.zonation.spp$species),]

```

```{r ALA_NSW_analysis, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
setwd("C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/")

# run loop to extract data from ALA and NSW atlas data by species 
for (i in seq(species.list)){
  # extract ALA data
  if (!is.na(threatened.species$Downloaded.ALA[threatened.species$Scientific.Name == species.list[i]]) == TRUE){
    ALA.data <- read.csv(glue("ALA data/",species.list[i],".csv"))
      ALA.labels <- c("Latitude...processed", "Longitude...processed")
    colnames(ALA.data)[which(names(ALA.data) %in% ALA.labels)] <- c("latitude", "longitude")
    ALA.data$index <- paste(sprintf("%.6f",ALA.data$latitude), sprintf("%.6f",ALA.data$longitude))
    ALA.data$database <- "ALA"
    ALA.data$species <- species.list[i]
  } else ALA.data <- NULL

  #extract NSW Atlas data
  if (!is.na(threatened.species$Downloaded.NSW[threatened.species$Scientific.Name == species.list[i]]) == TRUE){
    NSW.data <- read.csv(glue("NSW Atlas data/",species.list[i],".csv"))
    colnames(NSW.data)[c(21:22)] <- c("latitude", "longitude")
    NSW.data$index <- paste(sprintf("%.6f",NSW.data$latitude), sprintf("%.6f",NSW.data$longitude))
    NSW.data$database <- "NSW"
    NSW.data$species <- species.list[i]
  } else NSW.data <- NULL
  
  ALA.NSW.data <- combine.records(ALA.data[,c("species","longitude","latitude","database")],NSW.data[,c("species","longitude","latitude","database")])

  # only include species if more than the minimum number of records occur in the hunter
    ALA.NSW.points <- SpatialPoints(ALA.NSW.data[,c("longitude","latitude")])
    in.hunter <- nrow(d(ALA.NSW.points[complete.cases(over(ALA.NSW.points,hunter.mask)),]))
  
  # produce maps of the distribution of each species
  if(in.hunter > min.records) {
    print(sp.map <- base.map + geom_point(aes(x = longitude, y = latitude,color=database, shape=species), data = ALA.NSW.data, alpha=0.5))
  
  # output data for maxent analyses
    maxent.data <- rbind(maxent.data,ALA.NSW.data)
    cat("\n", "Adding", nrow(ALA.NSW.data), "records for", as.character(species.list[i]), "to maxent data")
  
    # create file for zonation analyses
    atlas.zonation.spp$species[i] <- glue(species.list[i],".asc")
    }
  
  # remove all species-specific datafiles, so they don't mess up the next round of the loop
  suppressWarnings(rm(ALA.data, NSW.data, ALA.NSW.data, ALA.NSW.points,in.hunter))
  gc()
}

zonation.spp <- rbind(brut.zonation.spp, atlas.zonation.spp)

# close pdf file
  if(save.maps == TRUE) dev.off()

  # print sample map for RMarkdown
  print(sp.map)
```
These are combined together in `maxent.data` where there are `r nrow(maxent.data)` records for `r (length(species.list) + n.species)` species.  Note that there may be duplicate records in these files but they should be filtered out by Maxent. A map of the distribution of each species is saved in a pdf file (*C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/species point data maps.pdf*)

```{r, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
h(maxent.data)

# convert maxent data to GDA94 Transverse Mercator Zone 56 to match the rest of the data
  coordinates(maxent.data) <- c("longitude", "latitude")
  
  # set current projection
  proj4string(maxent.data) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

  # transform to new projection
  project_maxent.data <- spTransform(maxent.data, CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))

  # convert back to a dataframe
  export_maxent.data <- as.data.frame(project_maxent.data)
    colnames(export_maxent.data)[3:4] <- c("easting","northing")

  h(export_maxent.data)
                                  
if(save.output ==TRUE) write.csv(export_maxent.data, "C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/maxent data/maxent.data.csv",row.names=FALSE)
```
The `zonation.spp` table lists each species and the required input for zonation.  These are currently all set to `1` and will require some tinkering as we get further down the line. This assumes that we will run all the listed species in Maxent from `maxent.data.csv`, creating all the relevant ascii files. *Or we will use this same data in biomod2.*

```{r, message=FALSE, warning=FALSE, comment="", tidy=TRUE}
h(zonation.spp)

if(save.output ==TRUE) write.table(zonation.spp,glue("C:/Users/awhitehead/Documents/GIS data/Hunter/species point data/maxent data/zonation.spp.txt"),sep="\t",row.names=FALSE, col.names=FALSE)
```

*This file was last updated on 4 March 2013 and last run on `r format(Sys.time(), "%d %B %Y")`.*
