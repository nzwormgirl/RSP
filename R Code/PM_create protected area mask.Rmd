Add security categories to LH protected areas layer
========================================================

This RMarkdown script takes individual layers representing protected areas within PMHC, assigns a *security of protection* score.  The layers are then merged and exported as a clipped file for use in Zonation analyses.

I have built this from the original individidual layers and compiled it to make sure that areas that have multiple classifications under different legislation end up with the correct categories. 


```{r setup, warning=FALSE,error=FALSE,echo=FALSE,message=FALSE,tidy=TRUE, results='hide'}
rm(list=ls())

packages(maptools)
packages(sp)
packages(rgeos)
packages(raster)
packages(rgdal)

# opts_chunk$set(dev="png", dev.args=list(type="cairo"), dpi=96, warning=FALSE,error=FALSE,echo=FALSE,message=FALSE,tidy=TRUE, results='hide')

# computer <- "//654cw-20990/Amy"
computer <- "H:/UM backup"
# setwd("~/GIS_data/Hunter/Plans/PA data for Amy - LH/")
output.directory <- paste0(computer,"/GIS_data/Hunter/zonation/port macquarie/")
input.directory <- paste0(computer,"/GIS_data/Hunter/PMHC Zonation GIS/")


GDA94.56 <- CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")
GDA94 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

create.raster <- function (s, mask.raster, raster.label, value=1, transform=FALSE) {
    
   if(transform==TRUE) {
     proj4string(s) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
    s <- spTransform(s, CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))
     }
    
  r <- rasterize(s,mask.raster)
    r[!is.na(r)] <- value
    r <- mask(merge(r,mask.raster),mask.raster, filename=paste0(output.directory,raster.label), format="GTiff", overwrite=T)
    names(r) <- rep(raster.label,length(names(r)))
    
    plot(r, main=raster.label,zlim=c(0,3),legend=F,axes=F)

    return(r)
  }

PM.mask <- raster(paste0(computer,"/GIS_data/Hunter/mask files/PM.mask.tif"))
  PM.mask.mask[!is.na(PM.mask)] <- 0

 # PMHC clipping mask
  PM.clipping.mask <- raster(paste0(computer,"/GIS_data/Hunter/mask files/PM.clipping.mask.tif"))
    PM.clipping.mask[!is.na(PM.clipping.mask)] <- 0

# LH administrative boundary
  PM.shp <- readShapePoly(paste0(input.directory,"PMHC LGA boundary.shp"), proj4=GDA94.56)
```


```{r import conservation layers, warning=FALSE,error=FALSE,echo=FALSE,message=FALSE,tidy=TRUE, results='hide'}

# National parks
  NPWS.shp <- readShapePoly(paste0(input.directory,"NPWS_and_State_Forest_land.shp"), proj4 = GDA94.56)

  NPWS.raster <- create.raster(NPWS.shp[!grepl("State Forest",NPWS.shp$TYPE),],PM.mask,raster.label = "NPWS.reserves", value=3)

# Declared wilderness
  declared_wilderness.shp <- readShapePoly(paste0(input.directory,"declared_wilderness.shp"), proj4string=GDA94.56)

  declared_wilderness.raster <- create.raster(declared_wilderness.shp,PM.mask,"declared_wilderness",value=3)

# State forests
  State_forests.raster <- create.raster(NPWS.shp[grepl("State Forest",NPWS.shp$TYPE),],PM.mask,"State_Forests",value=2)

# Wildlife refuges
  pnf.shp <- readShapePoly(paste0(input.directory,"pnf_approved_hastings_gda9456.shp"), proj4string=GDA94.56)
  pnf.raster <- create.raster(pnf.shp,PM.mask,"Private_Native_Forests",value=2)

# Protected Areas
  crown_council_land.shp <- readShapePoly(paste0(input.directory,"Crown_Council_protected_land.shp"),proj4string=GDA94.56)

  crown_council_land.raster <- create.raster(crown_council_land.shp, PM.mask, "Crown_Council_protected_land",value=2)

```


```{r merge rasters, warning=FALSE,error=FALSE,echo=FALSE,message=FALSE,tidy=TRUE, results='hide'}

protected.areas <- calc(stack(NPWS.raster,State_forests.raster,crown_council_land.raster,declared_wilderness.raster,pnf.raster),max)
  protected.areas[protected.areas<2] <- 1
  protected.areas <- mask(protected.areas,PM.mask)

  protected.areas <- protected.areas + 3  
    writeRaster(protected.areas, filename=paste0(output.directory,"PM_ProtectedAreas"), format="GTiff", overwrite=T)

# create constant protected areas layer
  protected.areas.constant <- protected.areas
  protected.areas.constant[protected.areas.constant>1] <- 2
  writeRaster(protected.areas.constant, filename=paste0(output.directory,"PM_ProtectedAreas_Constant"), format="GTiff", overwrite=T)

  png(paste0(output.directory,"PM_protected_areas.png"),height=15,width=15,units="cm",res=300, bg="transparent",pointsize=10)

  par(mar=c(0,0.25,3,0), oma=c(0,0,0,0))
  plot(protected.areas, zlim=c(1,3),legend=F,col = rev(terrain.colors(3)), main="Security of Protected Areas",axes=F, box=F)
    plot(add=T,PM.shp)
    legend("bottomright", bty="n",legend = c("High", "Low", "None"), fill = terrain.colors(3))
dev.off()

plot(protected.areas.constant, legend=F,col = rev(terrain.colors(2)), main="Protected Areas",axes=F,box=F)

```

The security layer was then clipped by the Lower Hunter vegetation mask for inclusion in the Zonation analyses.

```{r clip protected areas by vegetation mask for zonation, warning=FALSE,error=FALSE,echo=FALSE,message=FALSE,tidy=TRUE, results='hide'}
protected.areas.constant.clip <- mask(protected.areas.constant,PM.clipping.mask, filename=paste0(output.directory,"ProtectedAreas_Constant_clipped"), format="GTiff", overwrite=T)

protected.areas.clip <- mask(protected.areas,PM.clipping.mask, filename=paste0(output.directory,"ProtectedAreas_clipped"), format="GTiff", overwrite=T)


plot(protected.areas.constant.clip, legend=F, main="Protected Areas (clipped)",axes=F, box=F)
  plot(add=T,PM.shp)
plot(protected.areas.clip, zlim=c(1,3),legend=F,col = rev(terrain.colors(3)), main="Security of Protected Areas (clipped)",axes=F,box=F)
    plot(add=T,PM.shp)
    legend("bottomright", bty="n",legend = c("High", "Low", "None"), fill = terrain.colors(3))

```


```{r plots}
png(paste0(output.directory,"Protected_Areas_v4.png"),width=15,height=15,units = "cm",pointsize=12,bg="transparent",res=300)
par(mfrow=c(2,1))
  plot(protected.areas, zlim=c(3,6),legend=F,col = rev(terrain.colors(4)),axes=F,box=F)
    plot(LH.shp,add=T)
  plot(protected.areas.clip, zlim=c(3,6),legend=F,col = rev(terrain.colors(4)),axes=F,box=F)
    plot(LH.shp,add=T)
    legend("bottomright", bty="n",legend = c("High", "Medium", "Low"), fill = terrain.colors(4)[1:3])
dev.off()
```

```{r create word document, echo=FALSE,eval=FALSE}
setwd("~/RSP/R Code")
name <- "create and classify protected areas layer"
library(knitr)
library(pander)
knit(paste0(name, ".Rmd"), encoding = "utf-8")
name <- "create and classify protected areas layer"
Pandoc.brew(file = paste0(name, ".md"), output = name, convert = "docx")

```

***
*This file was last updated on 04 March 2014 and last run on `r format(Sys.time(), "%d %B %Y")`.*