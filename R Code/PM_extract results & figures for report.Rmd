---
title: "PM_extract results & figures for report"
author: "Amy Whitehead"
date: "Wednesday, April 22, 2015"
output: html_document
---


```{r set up}
rm(list=ls())
library(raster)
library(maptools)
library(colorRamps)
library(fields)

  GDA94.56 <- CRS("+proj=utm +zone=56 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")
  GDA94 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

# computer
# computer <- "~"
#computer <- "//654cw-20990/Amy"
computer <- "Z:/Amy"

# define paths for input and output files
input_path <- paste0(computer,'/GIS_data/Hunter/zonation/port macquarie/output/')
output_path <- paste0(computer,'/GIS_data/Hunter/zonation/port macquarie/')

# import biodiversity feature names
  names <- as.vector(read.table(paste0(output_path,'PM.zonation.spp'), header=F, sep='\t')[,6])
  names <- gsub('\\.PM\\.tif|_SDM|_SSI', '', names)

# date of the output files
  analysis.date <- '20150421' # remember to update to correct date


```


```{r import curve data}
# LH General impact assessment

# get names of Zonation curves-files (you can also do this manually)
files <- grep(paste0(analysis.date,'.curves.txt'), list.files(input_path), value=T) 
#   files <- files[files!=paste0("output_PMbase",analysis.date,".curves.txt")] # remove baseline scenario

# check for species that have zero observations at the start of the prioritisation
  baseline.curves <- read.table(paste0(input_path,"output_PMbase_",analysis.date,".curves.txt"), skip=1, header=F, sep='')
      colnames(baseline.curves) <- c('Prop_landscape_lost', 'cost_needed_for_top_fraction', 'min_prop_rem', 'ave_prop_rem', 'W_prop_rem', 'ext-1', 'ext-2', names)
  zero.obs <- baseline.curves[1,8:ncol(baseline.curves)]
    names(zero.obs[which(zero.obs==0)])

# when does the first species go extinct in the baseline scenario?
  extinct <- baseline.curves[baseline.curves$min_prop_rem==0,][1,]
    cat("First species goes extinct at step",row.names(extinct), "with",extinct$Prop_landscape_lost*100, "% removed","\n")
   names(extinct[which(extinct==0)])
  
# % species distributions in top fractions
  top5.sp <- baseline.curves$ave_prop_rem[baseline.curves$Prop_landscape_lost>=0.95][1]
  top10.sp <- baseline.curves$ave_prop_rem[baseline.curves$Prop_landscape_lost>=0.9][1]
  top30.sp <- baseline.curves$ave_prop_rem[baseline.curves$Prop_landscape_lost>=0.7][1]

```

```{r produce baseline priority map}

zonation_priority <- raster(paste0(input_path,"output_PMbase_",analysis.date,".rank.compressed.tif"))

PM.mask <- raster(paste0(computer,"/GIS_Data/Hunter/mask files/PM.mask.tif"))
PM.clipping.mask <- raster(paste0(computer,"/GIS_Data/Hunter/mask files/PM.clipping.mask.tif"))
PM.shp <- readShapePoly(paste0(computer,"/GIS_data/Port Macquarie/Data from PMH/PMHC LGA boundary.shp"), proj4=GDA94.56)

leg.labels <- c("top 5%","top 10%","top 15%","top 30%","top 50%","rest")
breaks <- c(0,0.2,0.5,0.75,0.9,0.95,0.98,1)
colours <- c("black","dark blue","blue","yellow","magenta","dark red", "red")

png(paste0(input_path,"PM_unweighted_zonation_priority.png"),height=7,width=15,units="cm",res=300, bg="transparent")
par(mar=c(0,0.25,0,0), oma=c(0,0,0,0))
plot(PM.mask,col="whitesmoke",legend=F,box=F,axes=F,zlim=c(1,7))
  plot(zonation_priority,col=blue2red(100),add=T,legend=F)
  plot(PM.shp, add=T, lwd=0.5)
  image.plot(legend.only=TRUE,smallplot=c(.85, .87, .35, .55),legend.width=0.75,legend.shrink=0.25, zlim= c(0,1), nlevel=100, col=blue2red(100),axis.args=list(at=c(0,1), labels=c("Low","High"), cex.axis=0.6),legend.args=list(text='Conservation priority', side=4, font=2, line=2.5, cex=0.7)) 
  scalebar(10000,type="line",divs=3,below="",cex=0.6,label=c("","10km",""))
dev.off()

png(paste0(input_path,"classified_zonation_priority.png"),height=7,width=15,units="cm",res=300, bg="transparent")
par(mar=c(0,0.25,0,0), oma=c(0,0,0,0))
plot(LH.mask,col="whitesmoke",legend=F,box=F,axes=F,zlim=c(1,7))
  plot(reclassified.zonation,col=blue2red(7),add=T,legend=F)
  plot(LH.shp, add=T, lwd=0.5)
  legend("bottomright",leg.labels,col=rev(blue2red(7)),pch=15,bty="n",title="Conservation priority",cex=0.7)
  scalebar(10000,type="line",divs=3,below="",cex=0.6,label=c("","10km",""))
dev.off()

top.30 <- zonation_priority
  top.30[top.30 < 0.7] <-NA
  top.30[!is.na(top.30)] <- 1

png(paste0(input_path,"top30_raster.png"),height=7,width=15,units="cm",res=300, bg="transparent")
par(mar=c(0,0.25,0,0), oma=c(0,0,0,0))
plot(LH.mask,col="whitesmoke",legend=F,box=F,axes=F)
  plot(top.30,col="brown",legend=F,add=T)
  plot(LH.shp, add=T, lwd=0.5)
  scalebar(10000,type="line",divs=3,below="",cex=0.6,label=c("","10km",""))
dev.off()


png(paste0(input_path,"priority_top30_raster.png"),height=14,width=15,units="cm",res=300, bg="transparent")
par(mar=c(0,0.25,0,0), oma=c(0,0,0,0),mfrow=c(2,1))
plot(LH.mask,col="whitesmoke",legend=F,box=F,axes=F,zlim=c(1,7))
  plot(zonation_priority,col=blue2red(100),add=T,legend=F)
  plot(LH.shp, add=T, lwd=0.5)
  image.plot(legend.only=TRUE,smallplot=c(.85, .87, .35, .55),legend.width=0.75,legend.shrink=0.25, zlim= c(0,1), nlevel=100, col=blue2red(100),axis.args=list(at=c(0,1), labels=c("Low","High"), cex.axis=0.6),legend.args=list(text='Conservation priority', side=4, font=2, line=2.5, cex=0.7)) 
  mtext("a)",side=3,line=-1,adj=0,cex=0.8)
  scalebar(10000,type="line",divs=3,below="",cex=0.6,label=c("","10km",""))

plot(LH.mask,col="whitesmoke",legend=F,box=F,axes=F)
  plot(top.30,col="brown",legend=F,add=T)
  plot(LH.shp, add=T, lwd=0.5)
  mtext("b)",side=3,line=-1,adj=0,cex=0.8)
dev.off()

```


```{r identify biodiversity features in runs}

species <- gsub("_"," ",names)

# number of features
length(species)

mnes.species <- species[species %in% protected.species$Scientific.Name[protected.species$mnes==TRUE]]
  mnes.species <- append(mnes.species,c("Swift Parrot","Regent Honeyeater",species[grep("Nominated",species)]))

birds <- species[species %in% protected.species$Scientific.Name[protected.species$Taxa=="birds"]]
  birds <- append(birds,c("Swift Parrot","Regent Honeyeater"))

amphibians <- species[species %in% protected.species$Scientific.Name[protected.species$Taxa=="amphibians"]]
mammals <- species[species %in% protected.species$Scientific.Name[protected.species$Taxa=="mammals"]]
plants <- species[species %in% protected.species$Scientific.Name[protected.species$Taxa=="plants"]]
reptiles <- species[species %in% protected.species$Scientific.Name[protected.species$Taxa=="reptiles"]]
tecs <- species[!species %in% protected.species$Scientific.Name]
  tecs <- tecs[!tecs %in% c("ghff foraging","ghff roosting","koala rawhabval6","Regent Honeyeater","Swift Parrot")]
sdm.species <- species[species %in% protected.species$Scientific.Name[protected.species$LH.sdm=="SDM"]]
  

cat("Total features:",length(names),"\n","MNES:",length(mnes.species),"\n", "amphibians:",length(amphibians),"\n","birds:",length(birds),"\n","mammals:",length(mammals),"\n","plants:",length(plants),"\n","reptiles:",length(reptiles),"\n","tecs:",length(tecs),"\n","SDM:",length(sdm.species)+7)

```
